<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mes Recettes</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script type="text/babel">
        const { useState, useEffect } = React;

        // Composants d'ic√¥nes simples en SVG
        const Plus = () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>;
        const Search = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>;
        const Shuffle = () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" /></svg>;
        const Filter = () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" /></svg>;
        const X = ({ className }) => <svg className={className || "w-6 h-6"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>;
        const Clock = ({ className }) => <svg className={className || "w-4 h-4"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>;
        const Book = ({ className }) => <svg className={className || "w-4 h-4"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>;
        const Tag = ({ className }) => <svg className={className || "w-5 h-5"} fill="none" stroke="currentColor" 
          viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 7h.01M7 3h5c.512 
          0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 
          014-4z" /></svg>;
        const ChefHat = () => <svg className="w-10 h-10 text-orange-600" viewBox="0 0 24 24" fill="#EA580C" 
          xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" 
          stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path fill-rule="evenodd" 
            clip-rule="evenodd" d="M7.25285 4.25547C8.09403 2.47951 9.90263 1.25 12 1.25C14.0974 1.25 15.906 2.47951 
            16.7471 4.25547C16.831 4.25184 16.9153 4.25 17 4.25C20.1756 4.25 22.75 6.82436 22.75 10C22.75 12.1806 
            21.5363 14.0762 19.75 15.0508L19.75 18.052C19.75 18.9505 19.7501 19.6997 19.6701 20.2945C19.5857 20.9223 
            19.4 21.4891 18.9445 21.9445C18.4891 22.4 17.9223 22.5857 17.2945 22.6701C16.6997 22.7501 15.9505 22.75 
            15.052 22.75H8.94801C8.04952 22.75 7.3003 22.7501 6.70552 22.6701C6.07773 22.5857 5.51093 22.4 5.05546 
            21.9445C4.59999 21.4891 4.41432 20.9223 4.32991 20.2945C4.24994 19.6997 4.24997 18.9505 4.25 18.052L4.25 
            15.0508C2.46371 14.0762 1.25 12.1806 1.25 10C1.25 6.82436 3.82436 4.25 7 4.25C7.08469 4.25 7.16899 4.25184 
            7.25285 4.25547ZM6.80262 5.7545C4.54704 5.85762 2.75 7.71895 2.75 10C2.75 11.7416 3.79769 13.2402 5.30028 
            13.8967C5.57345 14.016 5.75 14.2859 5.75 14.584V17.25H18.25L18.25 14.584C18.25 14.2859 18.4265 14.016 
            18.6997 13.8967C20.2023 13.2402 21.25 11.7416 21.25 10C21.25 7.71895 19.453 5.85761 17.1974 5.7545C17.2321 
            5.99825 17.25 6.24718 17.25 6.5V7C17.25 7.41421 16.9142 7.75 16.5 7.75C16.0858 7.75 15.75 7.41421 15.75 
            7V6.5C15.75 6.07715 15.6803 5.67212 15.5524 5.29486C15.0502 3.81402 13.6484 2.75 12 2.75C10.3516 2.75 
            8.94981 3.81402 8.44763 5.29486C8.3197 5.67212 8.25 6.07715 8.25 6.5V7C8.25 7.41421 7.91421 7.75 7.5 
            7.75C7.08579 7.75 6.75 7.41421 6.75 7V6.5C6.75 6.24717 6.76792 5.99825 6.80262 5.7545ZM18.2482 
            18.75H5.75181C5.75604 19.3194 5.77008 19.7491 5.81654 20.0946C5.87858 20.5561 5.9858 20.7536 6.11612 
            20.8839C6.24643 21.0142 6.44393 21.1214 6.90539 21.1835C7.38843 21.2484 8.03599 21.25 9 21.25H15C15.964 
            21.25 16.6116 21.2484 17.0946 21.1835C17.5561 21.1214 17.7536 21.0142 17.8839 20.8839C18.0142 20.7536 
            18.1214 20.5561 18.1835 20.0946C18.2299 19.7491 18.244 19.3194 18.2482 18.75Z" ></path> </g></svg>
        //fill="#1C274C"
        const API_URL = '/api';
        //const API_URL = 'http://localhost:8000/api';
        //const API_URL = import.meta.env.VITE_API_URL;
        //const API_URL = "https://recettes-roulette.onrender.com/api";


        function App() {
          const [recettes, setRecettes] = useState([]);
          const [recettesFiltrees, setRecettesFiltrees] = useState([]);
          const [categories, setCategories] = useState([]);
          const [showAddModal, setShowAddModal] = useState(false);
          const [selectedRecette, setSelectedRecette] = useState(null);
          const [showViewModal, setShowViewModal] = useState(false);
          const [showFilterPanel, setShowFilterPanel] = useState(false);
          const [recetteAleatoire, setRecetteAleatoire] = useState(null);
          const [loading, setLoading] = useState(false);

          const [nouvelleRecette, setNouvelleRecette] = useState({
            titre: '',
            duree_prep: '',
            // use objects { ingredient, quantity } in the form
            ingredients: [{ ingredient: '', quantity: '' }],
            categorie: '',
            sous_categorie: '',
            lien: '',
            livre: '',
            page: '',
            tags: [],
            notes: ''
          });

          const [filtres, setFiltres] = useState({
            categorie: '',
            sous_categorie: '',
            duree_max: '',
            recherche_texte: ''
            ,ingredient: ''
          });

          useEffect(() => {
            chargerRecettes();
            chargerCategories();
          }, []);

          // derive a unique list of ingredient NAMES for the filter dropdown
          const allIngredients = Array.from(new Set(recettes.flatMap(r => r.ingredients || []).map(i => {
            if (!i) return '';
            if (typeof i === 'string') {
              // if stored as "name - qty", keep only the name part
              const parts = i.split(' - ');
              return (parts[0] || '').trim();
            }
            return (i.ingredient || '').toString().trim();
          }).filter(Boolean))).sort((a,b) => a.localeCompare(b, 'fr'));

          const chargerRecettes = async () => {
            try {
              const response = await fetch(`${API_URL}/recettes`);
              const data = await response.json();
              setRecettes(data);
              setRecettesFiltrees(data);
            } catch (error) {
              console.error('Erreur chargement recettes:', error);
              const demoData = [
                {
                  id: 1,
                  titre: "P√¢tes Carbonara",
                  duree_prep: 20,
                  ingredients: ["P√¢tes", "Oeufs", "Lardons", "Parmesan"],
                  categorie: "Plat principal",
                  sous_categorie: "P√¢tes",
                  tags: ["Italien", "Rapide"]
                },
                {
                  id: 2,
                  titre: "Salade C√©sar",
                  duree_prep: 15,
                  ingredients: ["Salade romaine", "Poulet", "Parmesan", "Cro√ªtons"],
                  categorie: "Entr√©e",
                  sous_categorie: "Salade",
                  tags: ["Frais", "L√©ger"]
                }
              ];
              setRecettes(demoData);
              setRecettesFiltrees(demoData);
            }
          };

          const synchroniserAvecGitHub = async () => {
            try {
              const response = await fetch(`${API_URL}/recettes/sync`, {
                method: 'POST'
              });
              if (response.ok) {
                alert('‚úÖ Recettes synchronis√©es avec GitHub !');
              }
            } catch (error) {
              alert('‚ùå Erreur de synchronisation');
            }
          };

          const openRecette = (recette) => {
            setSelectedRecette(recette);
            setShowViewModal(true);
          };

          const supprimerRecette = async (recetteId) => {
            if (!confirm('Supprimer cette recette ?')) return;
            try {
              const response = await fetch(`${API_URL}/recettes/${recetteId}`, { method: 'DELETE' });
              if (response.ok) {
                // rafra√Æchir
                await chargerRecettes();
                setShowViewModal(false);
                // closed modal silently on success
              } else {
                alert('Erreur lors de la suppression');
              }
            } catch (err) {
              // fallback local removal
              setRecettes(recettes.filter(r => r.id !== recetteId));
              setRecettesFiltrees(recettesFiltrees.filter(r => r.id !== recetteId));
              setShowViewModal(false);
              // closed modal silently (demo mode)
            }
          };
          
          const chargerCategories = async () => {
            try {
              const response = await fetch(`${API_URL}/recettes/categories/liste`);
              const data = await response.json();
              setCategories(data);
            } catch (error) {
              setCategories([
                {
                  nom: "Entr√©e",
                  sous_categories: ["Salade", "Soupe", "Charcuterie"]
                },
                {
                  nom: "Plat principal",
                  sous_categories: ["Viande", "Poisson", "V√©g√©tarien", "P√¢tes", "Riz"]
                },
                {
                  nom: "Dessert",
                  sous_categories: ["Tarte", "G√¢teau", "Cr√®me", "Fruit"]
                }
              ]);
            }
          };

          const ajouterRecette = async () => {
            if (!nouvelleRecette.titre || !nouvelleRecette.duree_prep || !nouvelleRecette.categorie) {
              alert('Veuillez remplir tous les champs obligatoires');
              return;
            }

            // normalize ingredients: convert objects to strings "ingredient - quantity" or just ingredient
            const ingredientsFiltr√©s = nouvelleRecette.ingredients.map(it => {
              if (!it) return '';
              if (typeof it === 'string') return it.trim();
              const name = (it.ingredient || '').trim();
              const qty = (it.quantity || '').toString().trim();
              return qty ? `${name} - ${qty}` : name;
            }).filter(s => s && s.length > 0);

            if (ingredientsFiltr√©s.length === 0) {
              alert('Veuillez ajouter au moins un ingr√©dient');
              return;
            }

            const recetteData = {
              ...nouvelleRecette,
              duree_prep: parseInt(nouvelleRecette.duree_prep),
              page: nouvelleRecette.page ? parseInt(nouvelleRecette.page) : null,
              ingredients: ingredientsFiltr√©s
            };

            try {
              if (nouvelleRecette.id) {
                // Edition
                const response = await fetch(`${API_URL}/recettes/${nouvelleRecette.id}`, {
                  method: 'PUT',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(recetteData)
                });

                if (response.ok) {
                  await chargerRecettes();
                  setShowAddModal(false);
                  resetForm();
                  // closed modal silently on success
                }
              } else {
                // Cr√©ation
                const response = await fetch(`${API_URL}/recettes/`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(recetteData)
                });

                if (response.ok) {
                  await chargerRecettes();
                  setShowAddModal(false);
                  resetForm();
                  // closed modal silently on success
                }
              }
            } catch (error) {
              // Mode d√©mo: apply changes locally
              if (nouvelleRecette.id) {
                setRecettes(recettes.map(r => r.id === nouvelleRecette.id ? { ...r, ...recetteData } : r));
                setRecettesFiltrees(recettesFiltrees.map(r => r.id === nouvelleRecette.id ? { ...r, ...recetteData } : r));
                setShowAddModal(false);
                resetForm();
                // closed modal silently (demo mode)
              } else {
                const newRecette = {
                  ...recetteData,
                  id: recettes.length + 1,
                  date_ajout: new Date().toISOString()
                };
                setRecettes([...recettes, newRecette]);
                setRecettesFiltrees([...recettes, newRecette]);
                setShowAddModal(false);
                resetForm();
                // closed modal silently (demo mode)
              }
            }
          };

          const resetForm = () => {
            setNouvelleRecette({
              titre: '',
              duree_prep: '',
              ingredients: [{ ingredient: '', quantity: '' }],
              categorie: '',
              sous_categorie: '',
              lien: '',
              livre: '',
              page: '',
              tags: [],
              notes: ''
            });
          };

          const ajouterIngredient = () => {
            // add an empty ingredient object and focus the new ingredient input
            setNouvelleRecette(prev => {
              const updated = { ...prev, ingredients: [...prev.ingredients, { ingredient: '', quantity: '' }] };
              // small delay to ensure DOM has updated before focusing
              setTimeout(() => {
                try {
                  const inputs = document.querySelectorAll('input[name="ingredient"]');
                  if (inputs.length) {
                    const last = inputs[inputs.length - 1];
                    last.focus();
                    const val = last.value || '';
                    last.setSelectionRange(val.length, val.length);
                  }
                } catch (e) {}
              }, 50);
              return updated;
            });
          };

          const modifierIngredient = (index, field, value) => {
            const newIngredients = [...nouvelleRecette.ingredients];
            const current = newIngredients[index] || { ingredient: '', quantity: '' };
            newIngredients[index] = { ...current, [field]: value };
            setNouvelleRecette({ ...nouvelleRecette, ingredients: newIngredients });
          };

          const supprimerIngredient = (index) => {
            const newIngredients = nouvelleRecette.ingredients.filter((_, i) => i !== index);
            setNouvelleRecette({ ...nouvelleRecette, ingredients: newIngredients });
          };

          const appliquerFiltres = () => {
            let resultats = [...recettes];

            if (filtres.categorie) {
              resultats = resultats.filter(r => r.categorie === filtres.categorie);
            }

            if (filtres.sous_categorie) {
              resultats = resultats.filter(r => r.sous_categorie === filtres.sous_categorie);
            }

            if (filtres.duree_max) {
              resultats = resultats.filter(r => r.duree_prep <= parseInt(filtres.duree_max));
            }

            if (filtres.ingredient) {
              const termeIng = filtres.ingredient.toLowerCase();
              resultats = resultats.filter(r => r.ingredients && r.ingredients.some(i => i.toLowerCase().includes(termeIng)));
            }

            if (filtres.recherche_texte) {
              const terme = filtres.recherche_texte.toLowerCase();
              resultats = resultats.filter(r => 
                r.titre.toLowerCase().includes(terme) ||
                r.ingredients.some(ing => ing.toLowerCase().includes(terme))
              );
            }

            setRecettesFiltrees(resultats);
          };

          const reinitialiserFiltres = () => {
            setFiltres({
              categorie: '',
              sous_categorie: '',
              duree_max: '',
              recherche_texte: '',
              ingredient: ''
            });
            setRecettesFiltrees(recettes);
          };

          const tirerRecetteAleatoire = async () => {
            setLoading(true);
            try {
              const params = new URLSearchParams();
              if (filtres.categorie) params.append('categorie', filtres.categorie);
              if (filtres.duree_max) params.append('duree_max', filtres.duree_max);

              const response = await fetch(`${API_URL}/random/recette/simple?${params}`);
              
              if (response.ok) {
                const data = await response.json();
                setRecetteAleatoire(data);
              }
            } catch (error) {
              const recettesFiltreesLocal = recettesFiltrees.length > 0 ? recettesFiltrees : recettes;
              if (recettesFiltreesLocal.length > 0) {
                const random = recettesFiltreesLocal[Math.floor(Math.random() * recettesFiltreesLocal.length)];
                setRecetteAleatoire(random);
              }
            }
            setLoading(false);
          };

          const categorieSelectionnee = categories.find(c => c.nom === nouvelleRecette.categorie);

          return (
            <div className="min-h-screen bg-gradient-to-br from-orange-50 to-red-50">
              <header className="bg-white shadow-md">
                <div className="max-w-7xl mx-auto px-4 py-6 sm:px-6 lg:px-8">
                  <div className="flex justify-between items-center">
                    <div className="flex items-center gap-3">
                      <ChefHat />
                      <h1 className="text-3xl font-bold text-gray-900">Mes Recettes</h1>
                    </div>
                    <div className="flex items-stretch gap-2">
                      <a
                        href="../static/planner.html"
                        className="flex items-center gap-2 bg-purple-600 text-white px-4 py-3 rounded-lg hover:bg-purple-700 transition shadow-lg"
                      >
                        üìÖ
                        <span className="hidden sm:inline">Planning</span>
                      </a>

                      <button
                        onClick={synchroniserAvecGitHub}
                        className="flex items-center gap-2 bg-green-600 text-white px-4 py-3 rounded-lg hover:bg-green-700 transition shadow-lg"
                      >
                        ‚òÅÔ∏è
                        <span className="hidden sm:inline">Sync GitHub</span>
                      </button>
                      <button
                        onClick={() => { resetForm(); setShowAddModal(true); }}
                        aria-label="Nouvelle recette"
                        className="flex items-center gap-2 bg-orange-600 text-white px-4 py-3 sm:px-6 sm:py-3 rounded-lg hover:bg-orange-700 transition shadow-lg"
                      >
                        <Plus />
                        <span className="hidden sm:inline">Nouvelle recette</span>
                      </button>
                    </div>
                  </div>
                </div>
              </header>

              <main className="max-w-7xl mx-auto px-4 py-8 sm:px-6 lg:px-8">
                <div className="bg-white rounded-lg shadow-md p-6 mb-8">
                  <div className="flex gap-4 flex-wrap">
                    <div className="flex-1 min-w-[200px]">
                      <div className="relative">
                        <Search className="absolute left-3 top-3 w-5 h-5 text-gray-400" />
                        <input
                          type="text"
                          placeholder="Rechercher une recette..."
                          value={filtres.recherche_texte}
                          onChange={(e) => setFiltres({ ...filtres, recherche_texte: e.target.value })}
                          onKeyDown={(e) => { if (e.key === 'Enter') appliquerFiltres(); }}
                          className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                        />
                      </div>
                    </div>
                    <button
                      onClick={() => setShowFilterPanel(!showFilterPanel)}
                      className="flex items-center gap-2 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition"
                    >
                      <Filter />
                      Filtres
                    </button>
                    
                    <button
                      onClick={tirerRecetteAleatoire}
                      className="flex items-center gap-2 bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition"
                    >
                      <Shuffle />
                      Recette al√©atoire
                    </button>
                  </div>

                  {showFilterPanel && (
                    <div className="mt-4 pt-4 border-t border-gray-200 grid grid-cols-1 md:grid-cols-4 gap-4">
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">
                          Cat√©gorie
                        </label>
                        <select
                          value={filtres.categorie}
                          onChange={(e) => setFiltres({ ...filtres, categorie: e.target.value, sous_categorie: '' })}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500"
                        >
                          <option value="">Toutes</option>
                          {categories.map(cat => (
                            <option key={cat.nom} value={cat.nom}>{cat.nom}</option>
                          ))}
                        </select>
                      </div>

                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">
                          Sous-cat√©gorie
                        </label>
                        <select
                          value={filtres.sous_categorie}
                          onChange={(e) => setFiltres({ ...filtres, sous_categorie: e.target.value })}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500"
                          disabled={!filtres.categorie}
                        >
                          <option value="">Toutes</option>
                          {filtres.categorie && categories.find(c => c.nom === filtres.categorie)?.sous_categories.map(sc => (
                            <option key={sc} value={sc}>{sc}</option>
                          ))}
                        </select>
                      </div>

                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">
                          Ingr√©dient
                        </label>
                        <select
                          value={filtres.ingredient}
                          onChange={(e) => setFiltres({ ...filtres, ingredient: e.target.value })}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500"
                        >
                          <option value="">Tous</option>
                          {allIngredients.map(ing => (
                            <option key={ing} value={ing}>{ing}</option>
                          ))}
                        </select>
                      </div>

                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">
                          Dur√©e max (min)
                        </label>
                        <input
                          type="number"
                          min="0"
                          step="5"
                          value={filtres.duree_max}
                          onChange={(e) => setFiltres({ ...filtres, duree_max: e.target.value })}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500"
                          placeholder="Ex: 30"
                        />
                      </div>

                      <div className="md:col-span-3 flex gap-2">
                        <button
                          onClick={appliquerFiltres}
                          className="flex-1 bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700 transition"
                        >
                          Appliquer les filtres
                        </button>
                        <button
                          onClick={reinitialiserFiltres}
                          className="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition"
                        >
                          R√©initialiser
                        </button>
                      </div>
                    </div>
                  )}
                </div>

                {recetteAleatoire && (
                  <div
                    role="button"
                    tabIndex={0}
                    onClick={() => openRecette(recetteAleatoire)}
                    onKeyDown={(e) => { if (e.key === 'Enter') openRecette(recetteAleatoire); }}
                    className="bg-gradient-to-r from-purple-600 to-pink-600 rounded-lg shadow-xl p-8 mb-8 text-white cursor-pointer focus:outline-none focus:ring-2 focus:ring-white"
                  >
                    <div className="flex justify-between items-start mb-4">
                      <h2 className="text-2xl font-bold">üé≤ Suggestion du jour</h2>
                      <button
                        onClick={(e) => { e.stopPropagation(); setRecetteAleatoire(null); }}
                        className="text-white hover:text-gray-200"
                      >
                        <X />
                      </button>
                    </div>
                    <h3 className="text-3xl font-bold mb-4">{recetteAleatoire.titre}</h3>
                    <div className="flex gap-6 text-lg">
                      <span className="flex items-center gap-2">
                        <Clock />
                        {recetteAleatoire.duree_prep} min
                      </span>
                      <span className="flex items-center gap-2">
                        <Tag />
                        {recetteAleatoire.categorie}
                      </span>
                    </div>
                  </div>
                )}

                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                  {recettesFiltrees.map(recette => (
                    <div key={recette.id} onClick={() => openRecette(recette)} className="bg-white rounded-lg shadow-md hover:shadow-xl transition p-6 cursor-pointer">
                      <h3 className="text-xl font-bold text-gray-900 mb-3">{recette.titre}</h3>
                      
                      <div className="flex items-center gap-4 text-sm text-gray-600 mb-3">
                        <span className="flex items-center gap-1">
                          <Clock />
                          {recette.duree_prep} min
                        </span>
                        {recette.livre && (
                          <span className="flex items-center gap-1">
                            <Book />
                            p.{recette.page}
                          </span>
                        )}
                      </div>

                      <div className="mb-3">
                        <span className="inline-block bg-orange-100 text-orange-800 text-xs px-3 py-1 rounded-full">
                          {recette.categorie}
                        </span>
                        {recette.sous_categorie && (
                          <span className="inline-block bg-gray-100 text-gray-800 text-xs px-3 py-1 rounded-full ml-2">
                            {recette.sous_categorie}
                          </span>
                        )}
                      </div>

                      <div className="border-t border-gray-200 pt-3">
                        <p className="text-sm font-medium text-gray-700 mb-2">Ingr√©dients:</p>
                        <ul className="text-sm text-gray-600 space-y-1">
                          {recette.ingredients.slice(0, 3).map((ing, idx) => (
                            <li key={idx} className="flex items-start">
                              <span className="text-orange-600 mr-2">‚Ä¢</span>
                              {ing}
                            </li>
                          ))}
                          {recette.ingredients.length > 3 && (
                            <li className="text-gray-400 italic">
                              +{recette.ingredients.length - 3} autres...
                            </li>
                          )}
                        </ul>
                      </div>

                      {recette.tags && recette.tags.length > 0 && (
                        <div className="mt-3 flex flex-wrap gap-1">
                          {recette.tags.map((tag, idx) => (
                            <span key={idx} className="text-xs bg-blue-50 text-blue-700 px-2 py-1 rounded">
                              #{tag}
                            </span>
                          ))}
                        </div>
                      )}
                    </div>
                  ))}
                </div>

                {recettesFiltrees.length === 0 && (
                  <div className="text-center py-12">
                    <p className="text-gray-500 text-lg">Aucune recette trouv√©e</p>
                  </div>
                )}
              </main>

              {showAddModal && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 overflow-y-auto">
                  <div className="bg-white rounded-lg shadow-2xl max-w-2xl w-full my-8">
                    <div className="flex justify-between items-center p-6 border-b border-gray-200">
                      <h2 className="text-2xl font-bold text-gray-900">Nouvelle recette</h2>
                      <button
                        onClick={() => setShowAddModal(false)}
                        className="text-gray-400 hover:text-gray-600"
                      >
                        <X />
                      </button>
                    </div>

                    <div className="p-6 space-y-4 max-h-[70vh] overflow-y-auto">
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">
                          Titre de la recette *
                        </label>
                        <input
                          type="text"
                          value={nouvelleRecette.titre}
                          onChange={(e) => setNouvelleRecette({ ...nouvelleRecette, titre: e.target.value })}
                          className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500"
                          placeholder="Ex: P√¢tes √† la carbonara"
                        />
                      </div>

                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">
                          Dur√©e de pr√©paration (minutes) *
                        </label>
                        <input
                          type="number"
                          value={nouvelleRecette.duree_prep}
                          onChange={(e) => setNouvelleRecette({ ...nouvelleRecette, duree_prep: e.target.value })}
                          className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500"
                          placeholder="Ex: 30"
                        />
                      </div>

                      <div className="grid grid-cols-2 gap-4">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">
                            Cat√©gorie *
                          </label>
                          <select
                            value={nouvelleRecette.categorie}
                            onChange={(e) => setNouvelleRecette({ 
                              ...nouvelleRecette, 
                              categorie: e.target.value,
                              sous_categorie: '' 
                            })}
                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500"
                          >
                            <option value="">S√©lectionner...</option>
                            {categories.map(cat => (
                              <option key={cat.nom} value={cat.nom}>{cat.nom}</option>
                            ))}
                          </select>
                        </div>

                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">
                            Sous-cat√©gorie *
                          </label>
                          <select
                            value={nouvelleRecette.sous_categorie}
                            onChange={(e) => setNouvelleRecette({ ...nouvelleRecette, sous_categorie: e.target.value })}
                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500"
                            disabled={!nouvelleRecette.categorie}
                          >
                            <option value="">S√©lectionner...</option>
                            {categorieSelectionnee?.sous_categories.map(sc => (
                              <option key={sc} value={sc}>{sc}</option>
                            ))}
                          </select>
                        </div>
                      </div>

                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          Ingr√©dients *
                        </label>
                        <div className="space-y-2">
                          {nouvelleRecette.ingredients.map((ingObj, idx) => (
                            <div key={idx} className="flex gap-2 items-center">
                              <input
                                name="ingredient"
                                type="text"
                                value={ingObj.ingredient}
                                onChange={(e) => modifierIngredient(idx, 'ingredient', e.target.value)}
                                onKeyDown={(e) => { if (e.key === 'Enter') { e.preventDefault(); ajouterIngredient(); } }}
                                className="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500"
                                placeholder={`Ingr√©dient ${idx + 1}`}
                              />
                              <input
                                type="text"
                                value={ingObj.quantity}
                                onChange={(e) => modifierIngredient(idx, 'quantity', e.target.value)}
                                onKeyDown={(e) => { if (e.key === 'Enter') { e.preventDefault(); ajouterIngredient(); } }}
                                className="w-32 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500"
                                placeholder="Qt√© (ex: 200g)"
                              />
                              {nouvelleRecette.ingredients.length > 1 && (
                                <button
                                  onClick={() => supprimerIngredient(idx)}
                                  className="px-3 py-2 text-red-600 hover:bg-red-50 rounded-lg transition"
                                >
                                  <X className="w-5 h-5" />
                                </button>
                              )}
                            </div>
                          ))}
                        </div>
                        <button
                          onClick={ajouterIngredient}
                          className="mt-2 text-orange-600 hover:text-orange-700 text-sm font-medium flex items-center gap-1"
                        >
                          <Plus />
                          Ajouter un ingr√©dient
                        </button>
                      </div>

                      <div className="grid grid-cols-2 gap-4">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">
                            Livre (optionnel)
                          </label>
                          <input
                            type="text"
                            value={nouvelleRecette.livre}
                            onChange={(e) => setNouvelleRecette({ ...nouvelleRecette, livre: e.target.value })}
                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500"
                            placeholder="Ex: Cuisine italienne"
                          />
                        </div>

                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">
                            Page
                          </label>
                          <input
                            type="number"
                            value={nouvelleRecette.page}
                            onChange={(e) => setNouvelleRecette({ ...nouvelleRecette, page: e.target.value })}
                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500"
                            placeholder="Ex: 42"
                          />
                        </div>
                      </div>

                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">
                          Lien (optionnel)
                        </label>
                        <input
                          type="url"
                          value={nouvelleRecette.lien}
                          onChange={(e) => setNouvelleRecette({ ...nouvelleRecette, lien: e.target.value })}
                          className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500"
                          placeholder="https://..."
                        />
                      </div>

                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">
                          Notes (optionnel)
                        </label>
                        <textarea
                          value={nouvelleRecette.notes}
                          onChange={(e) => setNouvelleRecette({ ...nouvelleRecette, notes: e.target.value })}
                          rows="3"
                          className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500"
                          placeholder="Astuces, variantes..."
                        />
                      </div>
                    </div>

                    <div className="flex gap-3 p-6 border-t border-gray-200">
                      <button
                        onClick={() => setShowAddModal(false)}
                        className="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition"
                      >
                        Annuler
                      </button>
                      <button
                        onClick={ajouterRecette}
                        className="flex-1 bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700 transition"
                      >
                        Enregistrer les modifications
                      </button>
                    </div>
                  </div>
                </div>
              )}

              {showViewModal && selectedRecette && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 overflow-y-auto">
                  <div className="bg-white rounded-lg shadow-2xl max-w-2xl w-full my-8">
                    <div className="flex justify-between items-center p-6 border-b border-gray-200">
                      <h2 className="text-2xl font-bold text-gray-900">D√©tails de la recette</h2>
                      <button
                        onClick={() => setShowViewModal(false)}
                        className="text-gray-400 hover:text-gray-600"
                      >
                        <X />
                      </button>
                    </div>

                    <div className="p-6 space-y-4">
                      <h3 className="text-xl font-bold">{selectedRecette.titre}</h3>
                      <div className="text-sm text-gray-600">Dur√©e: {selectedRecette.duree_prep} min</div>

                      <div className="mt-2 flex items-center gap-2">
                        {selectedRecette.categorie && (
                          <span className="inline-block bg-orange-100 text-orange-800 text-xs px-3 py-1 rounded-full">
                            {selectedRecette.categorie}
                          </span>
                        )}
                        {selectedRecette.sous_categorie && (
                          <span className="inline-block bg-gray-100 text-gray-800 text-xs px-3 py-1 rounded-full">
                            {selectedRecette.sous_categorie}
                          </span>
                        )}
                      </div>

                      {selectedRecette.livre && <div className="text-sm">Livre: {selectedRecette.livre} p.{selectedRecette.page}</div>}
                      <div>
                        <p className="font-medium">Ingr√©dients:</p>
                        <ul className="list-disc pl-5 text-sm text-gray-700">
                          {selectedRecette.ingredients.map((ing, i) => {
                            let name = '';
                            let qty = '';
                            if (!ing) {
                              name = '';
                            } else if (typeof ing === 'string') {
                              const parts = ing.split(' - ');
                              name = parts[0] || '';
                              qty = parts[1] || '';
                            } else {
                              name = ing.ingredient || '';
                              qty = ing.quantity || '';
                            }
                            return (
                              <li key={i}>
                                {name}{qty ? ` - ${qty}` : ''}
                              </li>
                            );
                          })}
                        </ul>
                      </div>
                      {selectedRecette.notes && (
                        <div>
                          <p className="font-medium">Notes:</p>
                          <p className="text-sm text-gray-700">{selectedRecette.notes}</p>
                        </div>
                      )}
                    </div>

                    <div className="flex gap-3 p-6 border-t border-gray-200">
                      <button
                        onClick={() => {
                          // convert ingredient strings to objects for editing
                          const mappedIngredients = (selectedRecette.ingredients || []).map(i => {
                            if (!i) return { ingredient: '', quantity: '' };
                            if (typeof i === 'string') {
                              const parts = i.split(' - ');
                              return { ingredient: parts[0] || '', quantity: parts[1] || '' };
                            }
                            return { ingredient: i.ingredient || '', quantity: i.quantity || '' };
                          });
                          setShowViewModal(false);
                          setShowAddModal(true);
                          setNouvelleRecette({ ...selectedRecette, ingredients: mappedIngredients });
                        }}
                        className="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition"
                      >
                        √âditer
                      </button>
                      <button
                        onClick={() => supprimerRecette(selectedRecette.id)}
                        className="ml-auto bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition"
                      >
                        Supprimer
                      </button>
                    </div>
                  </div>
                </div>
              )}
            </div>
          );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>